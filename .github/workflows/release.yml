name: Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:

env:
  BINARY_NAME: plumeimpactor
  BINARY_NAME_CLI: plumesign
  BUNDLE_NAME: Impactor

jobs:
  build-and-release:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build ARM64 Release
        run: |
          export MACOSX_DEPLOYMENT_TARGET="11.0"
          cargo build --bins --workspace --release --target aarch64-apple-darwin

          mkdir -p dist
          cp target/aarch64-apple-darwin/release/${{ env.BINARY_NAME }} dist/${{ env.BINARY_NAME }}-macos-arm64
          cp target/aarch64-apple-darwin/release/${{ env.BINARY_NAME_CLI }} dist/${{ env.BINARY_NAME_CLI }}-macos-arm64

      - name: Import Codesign Certificate
        uses: apple-actions/import-codesign-certs@v5
        with:
          p12-file-base64: ${{ secrets.DEV_ID_P12_BASE64 }}
          p12-password: ${{ secrets.DEV_ID_P12_PASSWORD }}

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create App Bundle
        run: |
          make macos BIN1=dist/${{ env.BINARY_NAME }}-macos-arm64 BUNDLE=1 ARCH=arm64

      - name: Codesign App
        run: |
          mkdir -p dist/dmg
          mv dist/${{ env.BUNDLE_NAME }}.app dist/dmg/

          codesign --deep --force --options runtime \
            --sign "${{ secrets.DEV_ID_IDENTITY_NAME }}" \
            dist/dmg/${{ env.BUNDLE_NAME }}.app

      - name: Create DMG
        run: |
          create-dmg \
            --volname "${{ env.BUNDLE_NAME }}" \
            --background "package/macos/background.png" \
            --window-pos 200 120 \
            --window-size 510 350 \
            --icon-size 100 \
            --icon "${{ env.BUNDLE_NAME }}.app" 160 155 \
            --hide-extension "${{ env.BUNDLE_NAME }}.app" \
            --app-drop-link 350 155 \
            dist/${{ env.BUNDLE_NAME }}-macos-arm64.dmg \
            dist/dmg

      - name: Notarize DMG
        run: |
          xcrun notarytool submit \
            dist/${{ env.BUNDLE_NAME }}-macos-arm64.dmg \
            --apple-id "${{ secrets.APPLE_ID_EMAIL }}" \
            --password "${{ secrets.APPLE_ID_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_ID_TEAM }}" \
            --wait

          xcrun stapler staple \
            dist/${{ env.BUNDLE_NAME }}-macos-arm64.dmg

      - name: Extract Version
        id: version
        run: |
          VERSION=$(awk '/\[workspace.package\]/,/^$/' Cargo.toml | sed -nE 's/version *= *"([^"]*)".*/\1/p')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            dist/${{ env.BUNDLE_NAME }}-macos-arm64.dmg
            dist/${{ env.BINARY_NAME_CLI }}-macos-arm64
          generate_release_notes: true
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
